---
// src/pages/search.astro (é€™æ˜¯çœŸæ­£ä¿®æ­£å¾Œçš„å®Œæ•´ç‰ˆæœ¬)

import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// 1. æŠ“å–é—œéµå­—
// displayQuery ç”¨æ–¼é¡¯ç¤º (ä¿ç•™å¤§å°å¯«)
// searchQuery ç”¨æ–¼æœå°‹ (è½‰ç‚ºå°å¯«)
const displayQuery = Astro.url.searchParams.get('q') || null; 
const searchQuery = displayQuery?.toLowerCase() || null;

let filteredPosts = [];

// 2. å¦‚æœæœ‰é—œéµå­—ï¼Œæ‰åŸ·è¡Œæœå°‹
if (searchQuery) {
  const allPosts = await getCollection('blog');
  
  filteredPosts = allPosts.filter(post => {
    const title = post.data.title.toLowerCase();
    const description = post.data.description.toLowerCase();
    
    // --- é—œéµä¿®æ­£ï¼šæŠŠ post.body åŠ å›ä¾† ---
    // post.body æ˜¯å¯ç”¨çš„ï¼Œå®ƒä»£è¡¨æ–‡ç« çš„ã€ŒåŸå§‹ Markdown å…§æ–‡ã€
    const body = post.body.toLowerCase(); 

    // æœå°‹ æ¨™é¡Œã€æè¿°ã€æˆ–å…§æ–‡
    return title.includes(searchQuery) || 
           description.includes(searchQuery) || 
           body.includes(searchQuery);
  });
}
---
<BaseLayout>
    <div class="max-w-3xl mx-auto">

        <h1 class="text-3xl font-bold text-[var(--text-primary)] mb-4">æœå°‹æ–‡ç« </h1>

        <form action="/search" method="GET" class="flex items-center space-x-2 mb-8">
            <input 
                type="text" 
                name="q" 
                value={displayQuery || ''}  placeholder="æœå°‹æ–‡ç« ..." 
                class="w-full px-3 py-2 rounded-md border border-[var(--border-color)] text-sm text-[var(--text-primary)] bg-white focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]"
            >
            <button type="submit" class="px-4 py-2 bg-[var(--accent-color)] text-white text-sm rounded-md hover:bg-[var(--accent-hover)] transition">
                æœå°‹
            </button>
        </form>

        {searchQuery ? (
            <>
                <p class="text-lg text-[var(--text-secondary)] mb-6">
                    æ‰¾åˆ° {filteredPosts.length} ç¯‡é—œæ–¼ã€Œ<span class="font-bold text-[var(--text-primary)]">{displayQuery}</span>ã€çš„æ–‡ç« ï¼š
                </p>

                {filteredPosts.length > 0 ? (
                    <div class="space-y-8">
                        {filteredPosts.map(post => (
                            <article class="bg-[var(--bg-card)] rounded-xl shadow-lg overflow-hidden flex flex-row transition-all duration-300 hover:shadow-xl">
                                
                                <div class="p-6 md:p-8 flex-1">
                                    <div class="mb-2">
                                        <span class="text-sm font-medium text-white bg-[var(--accent-color)] py-1 px-3 rounded-full">{post.data.category}</span>
                                    </div>
                                    <h3 class="text-xl font-bold text-[var(--text-primary)] mb-3">
                                        <a href={`/blog/${post.slug}`} class="hover:text-[var(--accent-color)] transition-colors whitespace-pre-line">{post.data.title}</a>
                                    </h3>
                                    <p class="text-[var(--text-secondary)] text-base leading-relaxed mb-4 line-clamp-2">
                                        {post.data.description}
                                    </p>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-500">{new Date(post.data.publishDate).toLocaleDateString('zh-TW')}</span>
                                        <a href={`/blog/${post.slug}`} class="text-base font-semibold text-[var(--accent-color)] hover:text-[var(--accent-hover)] transition-colors">
                                            ç¹¼çºŒé–±è®€ &rarr;
                                        </a>
                                    </div>
                                </div>
                                
                                <div class="w-1/3 max-w-[120px] flex-shrink-0">
                                    <img src={post.data.previewImage} alt="æ–‡ç« é è¦½åœ–" class="w-full h-full object-cover">
                                </div>
                            </article>
                        ))}
                    </div>
                ) : (
                    <p class="text-center text-gray-500 text-lg py-10">
                        æ‰¾ä¸åˆ°ä»»ä½•ç¬¦åˆã€Œ<span class="font-bold text-[var(--text-primary)]">{displayQuery}</span>ã€çš„æ–‡ç«  ğŸ˜…
                    </p>
                )}
            </>
        ) : (
            <p class="text-center text-gray-500 text-lg py-10">
                è«‹åœ¨ä¸Šé¢çš„æœå°‹æ¡†è¼¸å…¥é—œéµå­—ã€‚
            </p>
        )}
    </div>
</BaseLayout>
