---
// æª”æ¡ˆè·¯å¾‘: src/components/CommentSystem.astro
interface Props {
  articleSlug: string;
  apiUrl: string;
  // é¸å¡«çš„ç½®é ‚ç•™è¨€è³‡æ–™çµæ§‹
  manualComment?: {
    name: string;
    date: string;
    content: string;
    avatarChar?: string; // èˆŠçš„ (å‚™ç”¨)
    avatarSrc?: string;  // ğŸ‘ˆ æ–°å¢ï¼šåœ–ç‰‡è·¯å¾‘
  };
}

const { articleSlug, apiUrl, manualComment } = Astro.props;
---

<div 
  id="comment-system-root"
  class="mt-12 bg-[var(--bg-card)] rounded-xl shadow-lg p-8 md:p-12"
  data-api-url={apiUrl}
  data-article-slug={articleSlug}
>
  <h3 class="text-2xl font-bold text-[var(--text-primary)] mb-6">è¨ªå®¢ç•™è¨€</h3>
  
  <form id="comment-form" class="space-y-4 mb-10">
    <div>
      <label for="comment-name" class="block text-sm font-semibold text-[var(--text-secondary)] mb-2">æ‚¨çš„åç¨± (å¿…å¡«)</label>
      <input type="text" id="comment-name" name="name" required class="w-full px-3 py-2 rounded-md border border-[var(--border-color)] text-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]" />
    </div>
    <div>
      <label for="comment-email" class="block text-sm font-semibold text-[var(--text-secondary)] mb-2">æ‚¨çš„ Email (é¸å¡«ï¼Œä¸æœƒå…¬é–‹)</label>
      <input type="email" id="comment-email" name="email" class="w-full px-3 py-2 rounded-md border border-[var(--border-color)] text-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]" />
    </div>
    <div>
      <label for="comment-content" class="block text-sm font-semibold text-[var(--text-secondary)] mb-2">æ‚¨çš„ç•™è¨€ (å¿…å¡«)</label>
      <textarea id="comment-content" name="content" rows="4" required class="w-full px-3 py-2 rounded-md border border-[var(--border-color)] text-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]"></textarea>
    </div>
    
    <div class="flex items-center">
      <input type="checkbox" id="comment-showOnSite" name="showOnSite" checked class="h-4 w-4 text-[var(--accent-color)] border-[var(--border-color)] rounded focus:ring-[var(--accent-color)]" />
      <label for="comment-showOnSite" class="ml-2 block text-sm text-[var(--text-secondary)]">æˆ‘åŒæ„å°‡æ­¤ç•™è¨€ï¼ˆåç¨±èˆ‡å…§å®¹ï¼‰å…¬é–‹é¡¯ç¤º</label>
    </div>

    <div class="pt-2">
      <button type="submit" id="comment-submit-btn" class="px-5 py-2 bg-[var(--accent-color)] text-white text-base font-medium rounded-md hover:bg-[var(--accent-hover)] transition disabled:opacity-50 disabled:cursor-not-allowed">
        é€å‡ºç•™è¨€
      </button>
      <span id="comment-status-msg" class="hidden ml-4 font-semibold"></span>
    </div>
  </form>

  <div class="space-y-6 border-t border-[var(--border-color)] pt-10">
    
    {manualComment && (
      <div class="flex space-x-4">
<div class="flex-shrink-0">
  {manualComment.avatarSrc ? (
    <img 
      src={manualComment.avatarSrc} 
      alt={manualComment.name} 
      class="w-10 h-10 rounded-full object-cover border border-[var(--border-color)]" 
    />
  ) : (
    <div class="w-10 h-10 rounded-full bg-[var(--accent-color)] flex items-center justify-center text-white font-semibold text-lg">
      {manualComment.avatarChar || 'K'}
    </div>
  )}
</div>
        <div class="flex-1">
          <div class="flex items-baseline space-x-2">
            <span class="font-bold text-[var(--text-primary)]">{manualComment.name}</span>
            <span class="text-xs text-gray-500">{manualComment.date}</span>
          </div>
          <p class="text-base text-[var(--text-secondary)] mt-2 whitespace-pre-line">{manualComment.content}</p> 
        </div>
      </div>
    )}

    <div id="dynamic-comments-container" class="space-y-6">
      <p class="text-center text-[var(--text-secondary)]">ç•™è¨€è¼‰å…¥ä¸­...</p>
    </div>

  </div>
</div>

<script>
  // å®šç¾©åˆå§‹åŒ–å‡½å¼
  function initCommentSystem() {
    const root = document.getElementById('comment-system-root');
    if (!root) return;

    const API_URL = root.dataset.apiUrl;
    const SLUG = root.dataset.articleSlug;
    const form = document.getElementById('comment-form') as HTMLFormElement;
    const submitBtn = document.getElementById('comment-submit-btn') as HTMLButtonElement;
    const statusMsg = document.getElementById('comment-status-msg');
    const listContainer = document.getElementById('dynamic-comments-container');

    if (!API_URL || !SLUG || !form || !listContainer) return;

    // --- åŠŸèƒ½ A: æŠ“å–ç•™è¨€ (æ¸…ç©ºé‡ç¹ªç­–ç•¥) ---
    async function fetchComments() {
      // 1. è¨­å®šè¼‰å…¥ç‹€æ…‹ (ä¸å½±éŸ¿ç½®é ‚ç•™è¨€)
      listContainer.innerHTML = '<p class="text-center text-[var(--text-secondary)]">ç•™è¨€è¼‰å…¥ä¸­...</p>';

      try {
        const res = await fetch(`${API_URL}?slug=${SLUG}`);
        const json = await res.json();

        if (json.result === 'success' && json.data) {
          // 2. æ¸…ç©ºå®¹å™¨ (å¾¹åº•é¿å…é‡è¤‡)
          listContainer.innerHTML = '';

          if (json.data.length === 0) {
             // å¦‚æœæ²’æœ‰å‹•æ…‹ç•™è¨€ï¼Œé¡¯ç¤ºæç¤º (é€™è£¡ä¸å½±éŸ¿ç½®é ‚ç•™è¨€)
             // è‹¥æœ‰ç½®é ‚ç•™è¨€ï¼Œé€™è£¡ç•™ç™½ä¹Ÿå¯ä»¥ï¼Œæˆ–è€…é¡¯ç¤ºã€Œå°šç„¡è¨ªå®¢ç•™è¨€ã€
             // é€™è£¡æˆ‘å€‘é¸æ“‡è‹¥ç„¡è¨ªå®¢ç•™è¨€å‰‡ä¸é¡¯ç¤ºä»»ä½•è¨Šæ¯ï¼Œä¿æŒç‰ˆé¢ä¹¾æ·¨
          } else {
            // 3. é‡ç¹ªæ‰€æœ‰ç•™è¨€
            json.data.forEach((comment: any) => {
              const dateStr = new Date(comment.timestamp).toLocaleString('zh-TW', {
                  year: 'numeric', month: '2-digit', day: '2-digit',
                  hour: 'numeric', minute: '2-digit', hour12: true
              });
              
              const div = document.createElement('div');
              div.className = 'flex space-x-4 animate-fade-in'; // å¯åŠ å€‹æ·¡å…¥å‹•ç•« class è‹¥æœ‰è¨­å®š
              div.innerHTML = `
                <div class="flex-shrink-0">
                  <div class="w-10 h-10 rounded-full bg-[var(--accent-color)] flex items-center justify-center text-white font-semibold text-lg">
                    ${comment.name.charAt(0).toUpperCase()}
                  </div>
                </div>
                <div class="flex-1">
                  <div class="flex items-baseline space-x-2">
                    <span class="font-bold text-[var(--text-primary)]">${comment.name}</span>
                    <span class="text-xs text-gray-500">${dateStr}</span>
                  </div>
                  <p class="text-base text-[var(--text-secondary)] mt-2 whitespace-pre-line">${comment.content}</p>
                </div>
              `;
              listContainer.appendChild(div);
            });
          }
        }
      } catch (e) {
        console.error(e);
        listContainer.innerHTML = '<p class="text-center text-red-500">ç„¡æ³•è¼‰å…¥ç•™è¨€ã€‚</p>';
      }
    }

    // --- åŠŸèƒ½ B: æäº¤è¡¨å–® (æŒ‰éˆ•é–å®šç­–ç•¥) ---
    if (form.dataset.bound !== 'true') {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // 1. é–å®šæŒ‰éˆ•
        submitBtn.disabled = true;
        submitBtn.textContent = 'è™•ç†ä¸­...';
        if (statusMsg) statusMsg.style.display = 'none';

        const formData = new FormData(form);
        const payload = {
          name: formData.get('name'),
          email: formData.get('email'),
          content: formData.get('content'),
          showOnSite: formData.get('showOnSite') === 'on',
          articleSlug: SLUG
        };

        try {
          const res = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
          });
          const json = await res.json();

          if (json.result === 'success') {
            // 2. æˆåŠŸç‹€æ…‹
            form.reset();
            if (statusMsg) {
              statusMsg.textContent = 'âœ“ ç•™è¨€å·²é€å‡ºï¼ç­‰å¾…æ›´æ–°ä¸­...';
              statusMsg.className = 'ml-4 font-semibold text-[#698a6a]';
              statusMsg.style.display = 'inline';
            }
            // å»¶é²é‡æ–°æŠ“å– (é¿å… Google Sheet å¯«å…¥å»¶é²)
            setTimeout(fetchComments, 1500);
          } else {
            throw new Error(json.message);
          }
        } catch (err) {
          // 3. å¤±æ•—ç‹€æ…‹
          if (statusMsg) {
            statusMsg.textContent = 'âœ— é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
            statusMsg.className = 'ml-4 font-semibold text-red-600';
            statusMsg.style.display = 'inline';
          }
        } finally {
          // 4. è§£é–æŒ‰éˆ• (ç„¡è«–æˆåŠŸå¤±æ•—)
          submitBtn.disabled = false;
          submitBtn.textContent = 'é€å‡ºç•™è¨€';
        }
      });
      form.dataset.bound = 'true';
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡ŒæŠ“å–
    fetchComments();
  }

  // ç¶å®š Astro é é¢åˆ‡æ›äº‹ä»¶
  document.addEventListener('astro:page-load', initCommentSystem);
</script>
